---
documentclass: article
title: "Solvabilté II : Calibration des chocs de capital de solvabilité requis avec expected shortfall."
author: "Kevin BAMOUNI"
date: "01/09/2020"
geometry: margin=1in
fontfamily: mathptmx
fontsize: 11pt
lang: fr-FR
# spacing: double
endnote: no
citecolor: cyan
output:
  pdf_document:
    df_print: kable
    fig_width: 7
    fig_height: 4
    fig_caption: true
    citation_package: natbib
    latex_engine: xelatex
    number_sections: true
bibliography: master.bib
---
  
  
    
Conservatoire National des Arts et Métiers (CNAM Paris) / EFAB  
Master 2 Actuariat  
STA217 Gestion quantitative du risque en finance et assurance  
  
Projet de fin d'année basé sur l'article "Solvency II solvency capital requirement for life insurance companies based on expected shortfall" de Tim J. Boonen publié en Octobre 2017.


```{r, echo = FALSE, fig.align = 'center', message=FALSE}
# Libraries
library(quantmod)
library(ggplot2)
library(dplyr)
library(cowplot)
library(actuar)
library(lifecontingencies)
library(reshape2)
library(dplyr)
library(readr)
library(RcppRoll)

# fichier de functions
# source("es_calibration_functions.R")

```


```{r, echo = FALSE, fig.align = 'center', message=FALSE}
# MSCI data load: source : https://www.msci.com/developed-markets aout 2020
msci <- read.csv(file = 'data/historyindex.csv', sep = ";", header = TRUE)[ ,c('Date', 'Price')]
msci$Date <- as.Date(msci$Date, "%d-%m-%Y")

# Utilisation des séries temporelle à la place : 
msci_ts <- ts(msci$Price, start = c(1969,12,31), frequency = 12)

# Source : The Human Mortality database : https://www.mortality.org/#:~:text=The%20Human%20Mortality%20Database%20(HMD,the%20history%20of%20human%20longevity.
# https://www.lifetable.de/cgi-bin/country.php?code=fra

fra_mortality <- read.csv(file = 'data/fra_qx_ret.csv', sep = ";", header = FALSE, dec = ".")
colnames(fra_mortality) <- fra_mortality[1,]
fra_mortality <- fra_mortality[2:dim(fra_mortality)[1],]
```


# INTRODUCTION

Academic workflow, certainly in political science, is at a crossroads. The *American Journal of Political Science* (*AJPS*) announced a (my words) ["show your work" initiative](http://ajps.org/2015/03/26/the-ajps-replication-policy-innovations-and-revisions/) in which authors who are tentatively accepted for publication at the journal must hand over the raw code and data that produced the results shown in the manuscript. The editorial team at *AJPS* then reproduces the code from the manuscript. Pending successful replication, the manuscript moves toward publication. The *AJPS* might be at the fore of this movement, and it could be the most aggressive among political science journals, but other journals in our field have signed the joint [Data Access & Research Transparency](http://www.dartstatement.org/) (DART) initiative. This, at a bare minimum, requires uploading code from quantitatively-oriented published articles to in-house directories hosted by the journal or to services like [Dataverse](http://dataverse.org/).

# SOLVABILITE 2


# MODELE DE L'ARTICLE : ESPECTED SHORTFALL POUR LA CALIBRATION DES CHOCS DE CALCUL DU SCR (CSR)


## DESCRIPTION


## MODELE DE CALIBRATION DES CHOCS DE CAPITAL DE SOLVABILITE REQUIS

### CALIBRATION DU CHOC SUR LES ACTIONS

Calibration du choc scr sur les actions

```{r, echo = FALSE, fig.align = 'center', message=FALSE}
# Most basic bubble plot
p1 <- ggplot(msci, aes(x=Date, y=Price)) +
  geom_area(fill = "lightgray", color="blue") + 
  xlab("Date") + ylab("Price")  + ggtitle("Evolution de la valeur de l'indice MSCI") + theme_classic()

# formule de calcul : (Pt - P(t-1))/P(t-1)
msci_return <-data.frame(diff(msci_ts)/stats::lag(msci_ts, -1))
colnames(msci_return) <- c("msci_return")

# anualisation
msci_return$msci_return <- 1+msci_return$msci_return
msci_return_annualized <-data.frame(roll_prod(msci_return$msci_return, n =12) - 1)
colnames(msci_return_annualized) <- c("msci_return_annualized")

p2 <- ggplot(msci_return_annualized, aes(x=index(msci_return_annualized), y=msci_return_annualized)) +
  geom_line( color="red") + 
  xlab("index") + ylab("return") + ggtitle("Rendement de l'indice MSCI") + theme_classic()

plot_grid(p1, p2, ncol = 1, align = "v")
```

Distribution des rendements

```{r, echo = FALSE, fig.align = 'center', message=FALSE}
p3 <- ggplot(msci_return_annualized, aes(msci_return_annualized)) +
  geom_histogram( bins = 50, color="darkgreen", fill="white") +
  xlab("return") + ylab("Nombre d'occurrence") + ggtitle("Rendement de l'indice MSCI") +
  theme_classic()

p4 <- ggplot(msci_return_annualized, aes(msci_return_annualized)) +
  geom_density(color="goldenrod2", fill = "gold1", alpha = 0.1) +
  stat_function(fun = dnorm, args = list(mean(msci_return_annualized$msci_return_annualized), sd(msci_return_annualized$msci_return_annualized)), color = "red") +
  geom_vline(xintercept = mean(msci_return_annualized$msci_return_annualized), colour = "#FF3721", linetype = "dashed") +
  xlab("return") + ylab("frequence en %") + ggtitle("Rendement de l'indice MSCI") +
  theme_classic()

plot_grid(p3, p4)
```

Value at risque historique sur les données de rendements annualisées 

```{r, echo = FALSE, fig.align = 'center', message=FALSE}
# Calcul de la VAR historique des données
histo_VAR <- round(quantile(msci_return, probs = c(0, 0.0005, 0.005, 0.01, 0.025, 0.5, 0.975, 0.99, 0.995, 0.9995, 1), na.rm = TRUE, names = TRUE, type = 1), 4)
knitr::kable(histo_VAR)
```

Value at risque d'une loi normale théorique

```{r, echo = FALSE, fig.align = 'center', message=FALSE}
# Calcul de la VAR théorique de la loi normale en supposant que les rendements suivent une loi normale
theo_VAR <- round(qnorm(c(0, 0.0005, 0.005, 0.01, 0.025, 0.5, 0.975, 0.99, 0.995, 0.9995, 1),mean=mean(msci_return$msci_return),sd=sd(msci_return$msci_return)), 4)
theo_VAR
```


```{r, echo = FALSE, fig.align = 'center', message=FALSE}
# msci_return$msci_return[msci_return$msci_return<histo_VAR[3]]
histo_ES <- round(mean(msci_return$msci_return[msci_return$msci_return<=histo_VAR[3]]), 4)
histo_ES
```


### CALIBRATION DU CHOC SUR LES TAUX


### CALIBRATION DU CHOC SUR LA LONGEVITE

```{r, echo = FALSE, fig.align = 'center', message=FALSE}
# transposition du dataframe des données de longévité
fra_mortality1 <- melt(fra_mortality, id.vars="Age")

# variable est du type factor, on sait ce qui s'en suit!!!
fra_mortality1 <- fra_mortality1 %>% filter(variable %in% c(1995:2015))

p5 <- ggplot(fra_mortality1, aes(Age, value, group=variable, color=variable)) + geom_line() +
  geom_vline(xintercept = "90", colour = "black", linetype = "dashed") + geom_vline(xintercept = "65", colour = "black", linetype = "dashed") + theme_classic() +
   theme_classic() + ylab("Probabilité de survie") + ggtitle("Evolution de la Table de survie entre 1995 et 2015")

p5

# TODO : Fix le 5 qui est en plein milieu sans raison valable là
```


```{r, echo = FALSE, fig.align = 'center', message=FALSE}
# Taux de changement de la longévité
fra_mortality_evol <- (fra_mortality[,3:dim(fra_mortality)[2]] - fra_mortality[,2:(dim(fra_mortality)[2]-1)])/fra_mortality[,2:(dim(fra_mortality)[2]-1)]
fra_mortality_evol$Age <- fra_mortality$Age

fra_mortality_evol1 <- melt(fra_mortality_evol, id.vars="Age", value.factor = FALSE)
fra_mortality_evol1$value <- as.numeric(fra_mortality_evol1$value)
fra_mortality_evol1 <- na.omit(fra_mortality_evol1)

p6 <- ggplot(fra_mortality_evol1, aes(value)) +
  geom_histogram( bins = 50, color="darkblue", fill="white") +
  xlab("taux d'évolution") + ylab("Nombre d'occurrence") + ggtitle("Histogramme des taux d'évolution de la longévité") +
  theme_classic()

p7 <- ggplot(fra_mortality_evol1, aes(value)) +
  geom_density(color="goldenrod2", fill = "gold1", alpha = 0.1) +
  #stat_function(fun = dnorm, args = list(mean(fra_mortality_evol1$value), sd(fra_mortality_evol1$value)), color = "red") +
  #geom_vline(xintercept = mean(fra_mortality_evol1$value), colour = "#FF3721", linetype = "dashed") +
  xlab("taux d'évolution") + ylab("frequence") + ggtitle("Rendement de l'indice MSCI") +
  theme_classic()

plot_grid(p6, p7)
```


# 3. THEORIE DES VALEURS EXTREMES POUR LA CALIBRATION DES CHOCS


# CONCLUSION


# REFERENCES 


# ANNEXES  avec codes, figures en plus etc.).

## packages R

## articles
