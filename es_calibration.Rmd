---
documentclass: article
title: "Solvabilté II : Calibration des chocs de capital de solvabilité requis avec expected shortfall."
author: "Kevin BAMOUNI"
date: "01/09/2020"
geometry: margin=1in
fontfamily: mathptmx
fontsize: 11pt
lang: fr-FR
# spacing: double
endnote: no
citecolor: cyan
output:
  pdf_document:
    df_print: kable
    fig_width: 7
    fig_height: 4
    fig_caption: true
    citation_package: natbib
    latex_engine: xelatex
    number_sections: true
bibliography: master.bib
---
  
  
    
Conservatoire National des Arts et Métiers (CNAM Paris) / EFAB  
Master 2 Actuariat  
STA217 Gestion quantitative du risque en finance et assurance  
  
Projet de fin d'année basé sur l'article "Solvency II solvency capital requirement for life insurance companies based on expected shortfall" de Tim J. Boonen publié en Octobre 2017.

\newpage

```{r, echo = FALSE, fig.align = 'center', message=FALSE}
# Libraries
library(quantmod)
library(ggplot2)
library(dplyr)
library(cowplot)
library(reshape2)
library(readr)
library(RcppRoll)
library(cvar)
library(tibble)
library(lubridate)
# fichier de functions
source("es_calibration_functions.R")
source("data_management.R")
```


```{r, echo = FALSE, fig.align = 'center', message=FALSE}
# MSCI data load: source : https://www.msci.com/developed-markets / Data d'extraction des données: 20 aout 2020
msci <- read.csv(file = 'data/historyindex.csv', sep = ";", header = TRUE)[ ,c('Date', 'Price')]
msci$Date <- as.Date(msci$Date, "%d-%m-%Y")

# Utilisation des séries temporelle à la place : 
msci_ts <- ts(msci$Price, start = c(1969,12,31), frequency = 12)

# Importdes données de taux : courbe historique de la bce / taux spot sans risque obligation noté AAA / extration 27/08/2020
bce_spot_rate_curve_histo <- read.csv(file = 'data/courbe_des_taux_historique_bce.csv', sep = ";", header = TRUE)
names(bce_spot_rate_curve_histo) <- gsub("YC.B.U2.EUR.4F.G_N_A.SV_C_YM.SR_", "", names(bce_spot_rate_curve_histo))

# importation des données de taux : courbe historique de la banque d'angleterre / taux spot sans risque 
#glc_spot_rate_curve_histo <- read.csv(file = 'data/courbe_des_taux_historique_bce.csv', sep = ";", header = TRUE)

```


# INTRODUCTION

Solvabilité II est une norme prudentielle  entré en vigueur en 2016 pour les assureurs et réassureurs européens déclinée par l'EIOPA (European Insurance and Occupational Pensions Authority). Cette norme établi un ensemble de directives afin de permettre d'identifier, de quantifier et gérer l'ensemble des risques propres à chaque entreprise. L'uniformisation des reportings introduits par la norme permet ainsi une standardisation des bonnes pratiques de gestion de risques, et de restitution d'informations prudentielles à travers l'europe. 

La norme introduit la notion de "best estimate liabilities" qui est la meilleure estimation possible des engagements de l'entreprise par l'entreprise à horizon d'un an. Pour se faire l'entreprise sur la base d’informations à jour et dignes de foi établie les hypothèses économiques et non économiques nécessaires à l'évaluation des flux financiers engendrés par ses engagements tout en tenant compte es garanties financières et options figurant dans les contrats d’assurance et de réassurance. La norme introduit également les notions de le minimum de capital requis (Minimum Capital Requirement – MCR en anglais) et de apital de solvabilité requis (Solvency Capital Requirement – SCR en anglais). Le SCR représente un coussin pour l'assureur, lui permettant en cas de choc extrêmes économiques et non économiques engendrant directement ou indirectement une augmentation de ses engagements affectant ses fonds propres de rester solvables.

L'évaluation du SCR est basé sur un scénario de stress extrême dit bicentenaire, c'est à dire un évènement ayant une probabilté d'occurence de 1/200. D'un autre point de vu, en cas d'évènement extrème une société d'assurance sur 200 au maximum devrait être insolvable. Afin d'établir ce scénario de stress bicentenaire selon la norme solvabilité II, le niveau de choc à appliquer sur les hypothèses économiques et non économiques centrales est calibré en utilisant un modèle de Value at risk (VaR). Dans son article, Tim J. Boonen (2017) effectue une calibration de choc par un modèle de expected shortfall sur quelques risques d'une société d'assurance fictive afin d'étudier les différences engendrées par l'utilisation de l'une ou l'autre des mesures de risque.

Dans ce document, nous implémentons les modèles de calibration des chocs sur les risque actions, longévité et taux par l'expected shortfall présentés dans l'article de Tim J.Boonen "Solvency II solvency capital requirement for life insurance companies based on expected shortfall" (2017).

Ce document se présentera comme suit, la première partie sera consacrée aux définitions des mesures de risques value at risk et expected shortfall. Dans la seconde partie nous introduirons la directive de solvabilité II pour le calcul du SCR en utilisant les chocs. L'implémentation du modèle d'expected shortfall pour la colibration  des chocs de taux, action et longévité inteviendra dans la troisiéme partie avec de proposer une méthode de calibration de choc basé sur la théorie des valeurs extrêmes..
 


# Mesures de risques

Calibration d'un choc au sens Solvabilité II se défini essentiellement par le niveau d'évolution négatif au sens de l'assureur à horizon d'un an d'un facteur de risque avec une probabilité de 1/200. Pour se faire, on utilise la value at risk pour déterminer ce niveau d'évolution du facteur de risque dit bicentenaire. 

la value at risk à un niveau $\alpha  \in  (0,1)$ est le $\alpha-$quantile, c'est à dire :
$$ VaR_\alpha(X) = inf\left\{  x \in  \mathbb{R} : (X>x)\leqslant 1-\alpha \right \} $$ 
Pour toute variable aléatoire $X$ représentant le niveau d'évolution d'un facteur de risque.
Au sens de la définition de Artzner et al. (1999) une mesure de risque est dite cohérente si elle est:

1. invariante par la translation 
2. sous-addtive
3. homogéne positive
4. monotone.
 
Par définition la value at risque n'est pas sous-additive. La sous-addivité est une propriété particulièrement importante car elle implique la de la mesure du risque lorsque les risques sont mutualisés. Ainsi nous introduisons une nouvelle mesure de risque cohérente, l'expected shortfall.
Soit $ES_\alpha$ l'expected shortfall de niveau $\alpha$:

$$ ES_\alpha(X) = \frac{1}{1-\alpha}\int_{\alpha}^{1} VaR_\tau (X)d\tau $$
Ou plus intuitivement, elle peut se définir comme "l'espérance des pertes au delà de la value at risque", c'est la définition que nous utiliserons dans la suite de ce document : 
$$ ES_\alpha (X) = E(X \mid  X\geqslant VaR_\alpha(X)) $$
Contrairement à la value at risk, en plus d'être une mesure de risque cohérente, l'expected shortfall est une mesure qui tient compte des queues de distribution des facteurs de risques mesurés. Cependant, les deux mesures de risque présentent leurs avantages et leurs inconvénients et sont encore discutées dans la littérature scientifique. L'object de ce document n'est pas de trancher en faveur de l'une ou l'autre des mesures de risque comme étant la meilleure, mais de présenter l'utilisation d'une mesure de risque pour la calibration de choc au sens de solvabilité II.


# Calcul du Capital de solvabilité requis (SCR) selon le pilier I de solvabilité II

Selon l'EIOPA dans la norme Solvabilité II, le capital de solvabilité requis (SCR) correspond à une value at risque d'un niveau 99,5% à l'horizon d'un an des fonds propres de l'assureur . Le principe de la formule standard est d'appliquer un certain de niveau de choc à chaque facteur de risque pouvant engendrer une perte financière, et d'évaluer l'impact sur ses fonds propres. Ces chocs sont calibrés avec une value at risk à un niveau 99,5% à l'horizon d'un an. L'assureur effectue l'exercice pour chaque module de risque, générant ainsi un SCR pour chaque risque, avant d'agréger l'ensemble des SCR à l'aide d'une matrice de corrélation prédéfinie (par la norme ou propre au profil de risque de l'entreprise) pour produire le SCR total.

Pour calculer le SCR total, l'assureur evalue tout d'abord avec des hypothèses économiques et non économiques dit centrales ses engagements, c'est le Best Estimate liabilities (BEL). Après avoir estimé son BEL et son actif (A) en valeur de marché, il détermine le niveau de ses fonds propres (FP) afin de produire son bilan prudentiel selon la formule simplifiée :

$$ A - BEL_{central} = FP_{central} $$ 

Lorsque l'assureur applique un choc négatif à un facteur de risque pour produire une nouvelle hypothèse économique ou non économique qui sera dite stressée avant de réévaluer le BEL et les fonds propres nous obtenons la nouvelle formule suivante :

$$ A - BEL_{choc\ du\ risque\ \lambda} = FP_{choc\ du\ risque\ \rho} $$
L'assureur suite au choc négatif sur une hypothèse évalue un BEL choqué qui sera supérieur au BEL central engendrant ainsi une variation à la baisse de ses fonds propres (central). Cette variation représente le SCR du risque relatif à l'hypothèse choquée. Ainsi :

$$ \Delta FP_{choc\ du\ risque\ \rho} = FP_{central} - FP_{choc\ du\ risque\ \rho} $$
Le SCR du risque $\rho$ se défini comme :

$$ SCR_{risque\ \rho} = max \left\{ \Delta FP_{choc\ du\ risque\ \rho}, 0 \right\} $$
Après avoir déterminé le SCR de chacun des facteurs de risque et sous risque, l'assureur les agrège à l'aide d'une matrice de corrélation des risques pour obtenir le SCR global.

Dans la suite de ce document nous calibrons les chocs de taux, action et longévité. En effet, les modules de risques de marché et de vie représentent environ 91,1% du SCR de base d'une compagnie d'assurance vie.


# Modèles de calibration des chocs pour le calcul du SCR

## Calibration du choc du risque action

Calibration du choc scr sur les actions

```{r, echo = FALSE, fig.align = 'center', message=FALSE, fig.cap= "Rendement de l'indice MSCI"}
# Most basic bubble plot
p1 <- ggplot(msci, aes(x=Date, y=Price)) +
  geom_area(fill = "lightgray", color="blue") + 
  xlab("Date") + ylab("Price")  + ggtitle("Evolution de la valeur de l'indice MSCI") + theme_classic()

# formule de calcul : (Pt - P(t-1))/P(t-1)
msci_return <-data.frame(diff(msci_ts)/stats::lag(msci_ts, -1))
colnames(msci_return) <- c("msci_return")

# anualisation
#msci_return$msci_return <- 1+msci_return$msci_return
msci_return_annualized <-data.frame(roll_prod(1+msci_return$msci_return, n =12) - 1)
colnames(msci_return_annualized) <- c("msci_return_annualized")

p2 <- ggplot(msci_return_annualized, aes(x=index(msci_return_annualized), y=msci_return_annualized)) +
  geom_line( color="red") + 
  xlab("index") + ylab("return") + theme_classic()

plot_grid(p1, p2, ncol = 1, align = "v")
```

Distribution des rendements

```{r, echo = FALSE, fig.align = 'center', message=FALSE, fig.cap= "Rendement de l'indice MSCI"}
p3 <- ggplot(msci_return_annualized, aes(msci_return_annualized)) +
  geom_histogram( bins = 50, color="darkgreen", fill="white") +
  xlab("return") + ylab("Nombre d'occurrence") + ggtitle("Rendement de l'indice MSCI") +
  theme_classic()

p4 <- ggplot(msci_return_annualized, aes(msci_return_annualized)) +
  geom_density(color="goldenrod2", fill = "gold1", alpha = 0.1) +
  stat_function(fun = dnorm, args = list(mean(msci_return_annualized$msci_return_annualized), sd(msci_return_annualized$msci_return_annualized)), color = "red") +
  geom_vline(xintercept = mean(msci_return_annualized$msci_return_annualized), colour = "#FF3721", linetype = "dashed") +
  xlab("return") + ylab("frequence en %") + 
  theme_classic()

plot_grid(p3, p4)
```

Value at risque historique sur les données de rendements annualisées 

```{r, echo = FALSE, fig.align = 'center', message=FALSE}
# Calcul de la VAR historique des données
histo_VAR <- round(quantile(msci_return_annualized, probs = c(0.005), na.rm = TRUE, type = 1), 4)
```

Value at risque d'une loi normale théorique

```{r, echo = FALSE, fig.align = 'center', message=FALSE}
# msci_return$msci_return[msci_return$msci_return<histo_VAR[3]]
histo_ES <- round(mean(msci_return_annualized$msci_return_annualized[msci_return_annualized$msci_return_annualized<=round(quantile(msci_return_annualized, probs = c(0.0115), na.rm = TRUE, type = 1), 4)]), 4)
```

: Calibration des chocs "global equity" avec la VaR et l'ES incluant un ajustement symétrique de 7,5%.

$\alpha(\%)$ |$\theta(\alpha)(\%)$ | $VaR_{\alpha}(\%)$    |$ES_{\theta(\alpha)}(\%)$|
-------------|-------------        | -------------         |---------------------    |
99.5         | 98.85               | `r histo_VAR*100-7.5` | `r histo_ES*100-7.5`    |



## Calibration du choc du risque de taux

```{r, echo = FALSE, fig.align = 'center', message=FALSE}
#bce_spot_rate_curve_histo_tible <- as_tibble(bce_spot_rate_curve_histo)
#bce_spot_rate_curve_histo_tible <- bce_spot_rate_curve_histo_tible %>% mutate(DATE = as_date(DATE, format="%d/%m/%y"))
#filter(bce_spot_rate_curve_histo_tible, DATE == as_date("2/08/2020", format="%d/%m/%y"))
melt_bce_spot_rate_curve_histo <- melt(bce_spot_rate_curve_histo[1:5,])

#melt_bce_spot_rate_curve_histo$DATE <- as.Date(melt_bce_spot_rate_curve_histo$DATE,format="%d/%m/%y")
#melt_bce_spot_rate_curve_histo <- filter(bce_spot_rate_curve_histo, DATE >= as.Date('01/01/2020', format="%d/%m/%y"))

p8 <- ggplot(melt_bce_spot_rate_curve_histo, aes(variable, value, group=DATE, color=DATE)) + geom_line(show.legend = TRUE)
p8
```
## Calibration du choc du risque de longévité.

```{r, echo = FALSE, fig.align = 'center', message=FALSE, fig.cap= "Evolution de la Table de mortalité en France entre 1992 et 2009"}
p5 <- ggplot(FR, aes(Age, qx, group=Year, color=Year)) + geom_line(aes(color = factor(Year))) +
  geom_vline(xintercept = "105-109", colour = "black", linetype = "dashed") +
   geom_vline(xintercept = "55-59", colour = "black", linetype = "dashed")+
    ylab("Probabilité de décès") +  scale_x_discrete(limits=c("0","1-4","5-9","10-14","15-19","20-24","25-29","30-34","35-39","40-44","45-49","50-54","55-59","60-64","65-69","70-74","75-79","80-84","85-89","90-94","95-99","100-104","105-109","110+"),guide = guide_axis(n.dodge = 2)) +
  theme_classic()

p5

# TODO : Fix le 5 qui est en plein milieu sans raison valable là    
```


Calcul des ES En moyenne pour toutes les tranches d'age et tous les pays.

```{r, echo = FALSE, fig.align = 'center', message=FALSE}
join_qx_df <- left_join(DEN_reshape, FR_reshape, by='Age') %>% left_join(EST_reshape, by = 'Age') %>% left_join(HUN_reshape, by = 'Age') %>% left_join(IT_reshape, by = 'Age') %>% left_join(POL_reshape, by = 'Age') %>% left_join(SWE_reshape, by = 'Age') %>% left_join(ENGW_reshape, by = 'Age') %>% left_join(CZE_reshape, by = 'Age')

join_qx_df <- column_to_rownames(join_qx_df, var = "Age")

es_theo <- function(vect, qq){
  return(ES(qnorm, x = qq, mean = mean(vect), sd = sd(vect)))
}

var_theo <- function(vect, qq){
  return(VaR(qnorm, x = qq, mean = mean(vect), sd = sd(vect)))
}

# Theta choisi tel la var = es
es_longe <- round(mean(-apply(join_qx_df[1:22,], 1, es_theo, qq=0.0129))*100,2)

var_longe <- round(mean(-apply(join_qx_df[1:22,], 1, var_theo, qq=0.005))*100,2)
```



```{r, echo = FALSE, fig.align = 'center', message=FALSE, fig.cap= "Another amazing plot"}
dt1 <- melt(join_qx_df["55-59",])


p6 <- ggplot(dt1, aes(value)) +
    geom_density(color="aquamarine2", fill = "aquamarine2", alpha = 0.1) +
    stat_function(fun = dnorm, args = list(mean(dt1$value), sd(dt1$value)), color = "brown") +
    geom_vline(xintercept = mean(dt1$value), colour = "#FF3721", linetype = "dashed") +
    xlab("taux d'évolution") + ylab("frequence en %") + 
    theme_classic()
  

p7 <- ggplot(dt1, aes(sample=value)) + stat_qq(color="darkgrey") + stat_qq_line(color = "brown")+ 
    theme_classic()

plot_grid(p6, p7, ncol = 1, align = "v")

```



: Calibration des chocs "longévité" avec la VaR et l'ES.

$\alpha(\%)$   | $\theta(\alpha)(\%)$ | $VaR_{\alpha}(\%)$    |$ES_{\theta(\alpha)}(\%)$|
---------------|-------------         | -------------         |---------------------    |
99.5           | 98.71                | `r var_longe`         | `r es_longe`            |

# Théorie des valeurs extrêmes pour la calibration des chocs

.dfqsdfqsdfqsdfsdfqsdfqsfdfqsfdfqsffqsdfsdfsdfsdfsf

# Conclusion

.sdhjqkJSHIZuikjhkQHDQSIuhdqsiu

# Références

Boonen, T.J. Solvency II solvency capital requirement for life insurance companies based on expected shortfall. Eur. Actuar. J. 7, 405–434 (2017).

Committee of European Insurance and Occupational Pensions Supervisors (2010) Solvency II calibration paper.

Base de données de de la BCE pour les données de "spot yiel curve" de la zone euro consulté en 08/2020, https://sdw.ecb.europa.eu/home.do 

Base de données de la banque d'angleterre pour les données de "Daily government liability curve (nominal)" consulté en 08/2020, https://www.bankofengland.co.uk/

Base de données de l'indice MSCI World : https://www.msci.com/developed-markets

# Annexes avec codes, figures en plus etc.).

.

## Packages R

1. library(quantmod)
2. library(ggplot2)
3. library(dplyr)
4. library(cowplot)
5. library(reshape2)
6. library(readr)
7. library(RcppRoll)
8. library(cvar)
9. library(tibble)
10. library(lubridate)
11. library(FactoMineR)
12. library(factoextra)

## Articles
